From: Dan Lenski <dlenski@gmail.com>
Date: Sun, 7 Aug 2016 02:01:07 +0200
Subject: restore original cwd after vpnc_main_loop()

Origin: http://lists.unix-ag.uni-kl.de/pipermail/vpnc-devel/2016-August/004200.html
---
 tunip.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/tunip.c b/tunip.c
index 00d9e1c..e2ab9e2 100644
--- a/tunip.c
+++ b/tunip.c
@@ -53,6 +53,7 @@
  *
  */
 
+#define _GNU_SOURCE
 #include <sys/types.h>
 #include <sys/socket.h>
 #include <errno.h>
@@ -985,6 +986,7 @@ void vpnc_doit(struct sa_block *s)
 	struct encap_method meth;
 
 	const char *pidfile = config[CONFIG_PID_FILE];
+	char *cwd;
 
 	switch (s->ipsec.encap_mode) {
 		case IPSEC_ENCAP_TUNNEL:
@@ -1038,6 +1040,10 @@ void vpnc_doit(struct sa_block *s)
 	signal(SIGINT, killit);
 	signal(SIGTERM, killit);
 
+	/* save cwd */
+	cwd = get_current_dir_name();
+	assert(cwd != NULL);
+
 	chdir("/");
 
 	if (!opt_nd) {
@@ -1067,6 +1073,10 @@ void vpnc_doit(struct sa_block *s)
 
 	vpnc_main_loop(s);
 
+	/* restore cwd */
+	chdir(cwd);
+	free(cwd);
+
 	if (pidfile)
 		unlink(pidfile); /* ignore errors */
 }
